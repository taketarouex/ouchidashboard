name: Test

on: 
  push:
    branches: '**'
    tags: 'release**'
    paths-ignore: 
    - 'README.md'
    - 'cloudbuild.yaml'
env:
  IMAGE_NAME: ouchi-dashboard

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Unit test
        run: make test
      - name: Build the stack
        env:
          GCP_PROJECT: test
          NATURE_REMO_ACCESS_TOKEN: ${{ secrets.NATURE_REMO_ACCESS_TOKEN }}
          FIRESTORE_ROOT_PATH: test
        run: docker-compose up -d
      - name: Integration Test
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8812
          FIRESTORE_ROOT_PATH: test
          GCP_PROJECT: test
        run: make integration_test
      - name: E2E Test
        env:
          NATURE_REMO_DEVICE_ID: ${{ secrets.NATURE_REMO_DEVICE_ID }}
          FIRESTORE_EMULATOR_HOST: localhost:8812
          FIRESTORE_ROOT_PATH: test
          GCP_PROJECT: test
        run: make e2e_test
  push:
    name: Push to GitHub Docker Repository
    runs-on: ubuntu-latest
    needs: test-build
    if: startsWith(github.ref, 'release')
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build
        run: docker-compose build app
      - name: Log into GitHub Container Registry
        run: echo "${{ secrets.CR_PAT }}" | docker login https://ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Push image to GitHub Container Registry
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

          # Strip git ref prefix from version
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')

          # Strip "v" prefix from tag name
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')

          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION

          docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION
